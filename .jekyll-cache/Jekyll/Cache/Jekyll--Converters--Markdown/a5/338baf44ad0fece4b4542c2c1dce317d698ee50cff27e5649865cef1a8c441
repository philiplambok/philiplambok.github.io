I"—:<p>Setelah sekian lama pensi, akhirnya ada kesempatan untuk nulis lagi.</p>

<p>Pada kesempatan ini saya mau bahas <em>form object</em>. Jika anda sudah mengenal atau pernah menggunakan form object di projek anda, mungkin tulisan ini bisa untuk refrerensi.</p>

<p>Saya yakin dari pembaca sudah banyak menggenal form object. Form object adalah sebuah object yang mempresentasikan sebuah form. Jadi dengan form object ini, sebuah form yang kita buat adalah sebuah object yang utuh.</p>

<p>Form object ini baiknya digunakan ketika anda memiliki sebuah form yang melibatkan lebih dari satu model, atau bahkan form anda tidak memiliki table atau model apapun. Namun jika form anda hanya terdiri dari satu model, maka anda tidak perlu menggunakan form object ini karena akan <em>over engineering</em>.</p>

<p>Seperti biasa, agar konsepnya lebih masuk kita akan membuat sebuah studi kasus. Studi kasusnya simple saja.Kita akan membuat sebuah form untuk menginput organisasi baru.</p>

<p>Kira-kira formnya akan seperti in:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Nama Organisasi: &lt;String&gt;
Nama Anda: &lt;String&gt;
Email Anda: &lt;String&gt;

&lt;Button Submit&gt;
</code></pre></div></div>

<p>Dan untuk rancangan tablenya akan seperti ini:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>table_name: organizations
id: integer
name: string
user_id: integer
created_at: datetime
updated_at: datetime

---

table_name: users
id: integer
name: string
email: string
created_at: string
updated_at: string
</code></pre></div></div>

<p>Jadi, form yang akan kita buat akan memuat dua buah model yang berbeda.</p>

<p>Sekarang mari kita buat form tersebut dengan menulis kode testnya terlebih dahulu:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s1">'Create new organization'</span><span class="p">,</span> <span class="ss">type: :system</span> <span class="k">do</span>
  <span class="n">context</span> <span class="s1">'with valid params'</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">'returns success message'</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">new_organization_path</span>
      <span class="n">fill_in</span> <span class="ss">:organization_form_name</span><span class="p">,</span> <span class="ss">with: </span><span class="s1">'Ruby conf'</span>
      <span class="n">fill_in</span> <span class="ss">:organization_form_user_name</span><span class="p">,</span> <span class="ss">with: </span><span class="s1">'Philip Lambok'</span>
      <span class="n">fill_in</span> <span class="ss">:organization_form_user_email</span><span class="p">,</span> <span class="ss">with: </span><span class="s1">'philiplambok@gmail.com'</span>
      <span class="n">click_on</span> <span class="s1">'Submit'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_content</span> <span class="s1">'Organization has been created'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s1">'with invalid params'</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">'returns error message'</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">new_organization_path</span>
      <span class="n">click_on</span> <span class="s1">'Submit'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_content</span> <span class="s2">"Name can't be blank"</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_content</span> <span class="s2">"User name can't be blank"</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_content</span> <span class="s2">"User email can't be blank"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Setelah specnya telah dibuat, maka sekarang mari kita buat kode testnya menjadi <em>passed</em>.</p>

<p>Tambahkan <code class="language-plaintext highlighter-rouge">routes.rb</code></p>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:organizations</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Tambahkan controller <code class="language-plaintext highlighter-rouge">organizations_controller.rb</code></p>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">OrganizationsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@form</span> <span class="o">=</span> <span class="no">OrganizationForm</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">form</span> <span class="o">=</span> <span class="no">OrganizationForm</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">form_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">form</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">flash</span><span class="p">[</span><span class="ss">:success</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Organization has been created'</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="p">[</span><span class="ss">:error</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">full_messages</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">redirect_to</span> <span class="n">new_organization_path</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">form_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:organization_form</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span>
      <span class="ss">:name</span><span class="p">,</span> <span class="ss">:user_name</span><span class="p">,</span> <span class="ss">:user_email</span>
    <span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Lalu sekarang tambahkan form object: <code class="language-plaintext highlighter-rouge">organization_form.rb</code>-nya</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">OrganizationForm</span>
  <span class="kp">include</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Model</span>
  <span class="kp">include</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Attributes</span>

  <span class="n">attribute</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="n">attribute</span> <span class="ss">:user_name</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="n">attribute</span> <span class="ss">:user_email</span><span class="p">,</span> <span class="ss">:string</span>

  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:user_name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:user_email</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>

  <span class="k">def</span> <span class="nf">save</span>
    <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">invalid?</span>

    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">name: </span><span class="n">user_name</span><span class="p">,</span> <span class="ss">email: </span><span class="n">user_email</span><span class="p">)</span>
    <span class="n">user</span><span class="p">.</span><span class="nf">save</span>
    <span class="n">organization</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">organizations</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">name: </span><span class="nb">name</span><span class="p">)</span>
    <span class="n">organization</span><span class="p">.</span><span class="nf">save</span>

    <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Jangan lupa juga untuk model-modelnya:</p>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Organization</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:organizations</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Dan terakhir untuk views-nya</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%</span> <span class="n">flash</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;p&gt;</span><span class="cp">&lt;%=</span> <span class="n">value</span> <span class="cp">%&gt;</span><span class="nt">&lt;/p&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">form_with</span> <span class="ss">model: </span><span class="vi">@form</span><span class="p">,</span> <span class="ss">url: </span><span class="n">organizations_path</span><span class="p">,</span> <span class="ss">local: </span><span class="kp">true</span> <span class="k">do</span> <span class="o">|</span><span class="n">form</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:user_name</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:user_name</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:user_email</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:user_email</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Submit"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<p>Lalu jalankan testnya, maka hasilnya akan <em>passed</em>.</p>

<p>Pada form object ini saya menggunakan dua module yang ada di active-model, yaitu <a href="https://api.rubyonrails.org/classes/ActiveModel/Model.html"><code class="language-plaintext highlighter-rouge">ActiveModel::Model</code></a> agar form kita bisa layaknya model memiliki build-in <code class="language-plaintext highlighter-rouge">validations</code>, <code class="language-plaintext highlighter-rouge">errors</code>, <code class="language-plaintext highlighter-rouge">invalid</code>, <code class="language-plaintext highlighter-rouge">valid</code>, dll.</p>

<p>Selain itu juga saya menggunakan <a href="https://api.rubyonrails.org/classes/ActiveModel/Attributes/ClassMethods.html"><code class="language-plaintext highlighter-rouge">ActiveModel::Attributes</code></a> agar saya bisa menggunakan callback <code class="language-plaintext highlighter-rouge">attribute</code> di form object yang saya punya.</p>

<p>Dibandingkan dengan menggunakan <code class="language-plaintext highlighter-rouge">attr_accessor</code>, menggunakan <code class="language-plaintext highlighter-rouge">attribute</code> kita bisa men-<em>define</em> tipe data dari attribute kita, dan juga kita bisa membuat default value disaat kita perlu.</p>

<hr />
<p>Saya kira cukup untuk tulisan tentang pengenalan form object ini, jika anda tertarik dengan kode sumbernya dapat melihat kodenya <a href="https://github.com/sugar-for-pirate-king/how-to-use-form-object">disini</a>.</p>

<p>Selamat hacking~</p>
:ET