I".;<p>Karna terpicu tentang kejadian kebobolan data yang ramai belakangan ini, saya jadi ingin coba oprek-oprek tentang enkripsi data.</p>

<p>Pada tulisan ini akan berbagi sesuatu yang baru saja saya pelajari. Kita akan membuat sebuah projek kecil-kecilan seperti biasanya.</p>

<p>Kita akan membuat sebuah projek yang bisa menyimpan sebuah data karyawan, dimana ada atribut yang kita enkripsi, yaitu salary (gaji).</p>

<p>Saya akan menggunakan Rails dan library(gem) yang menarik yaitu <a href="https://github.com/ankane/lockbox">lockbox</a> dan <a href="https://github.com/ankane/blind_index">blind_index</a>.</p>

<p>Saya menggunakan library ini karena interface dan migrasi yang sangat mudah. Mari kita mulai dengan membuat projeknya.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$&gt; rails new try-db-encrypt --database=mysql
</code></pre></div></div>

<p>Saya menggunakan mysql, bukan sqlite agar databasenya bisa di akses lewat db client di local saya.</p>

<p>Lalu buat scaffolding employee-nya, saya akan membuatnya sangat simple saja:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$&gt; rails g scaffold employee full_name salary:integer
</code></pre></div></div>

<p>Lalu mari kita buka halaman employees-nya dan tambahkan data. Kita tidak mengimplementasikan enkripsinya terlebih dahulu agar skalian mencontohkan cara migrasi data dari plain data. Karna pada realitas projek yang ada tidak dibuat dengan enkripsi di tempat pertama.</p>

<p>Setelah anda menambahkan beberapa data, saatnya kita mengintall lockbox. Tambahkan gem ini pada file <code class="language-plaintext highlighter-rouge">Gemfile</code>:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s1">'lockbox'</span>
</code></pre></div></div>

<p>Lalu jalankan <code class="language-plaintext highlighter-rouge">bundle install</code>.</p>

<p>Pertama kita generate dulu random keynya dengan:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Lockbox</span><span class="p">.</span><span class="nf">generate_key</span> 
<span class="c1">#&gt; '103cc6ebf93fd0d146dfdbc8791218bcf07e1dfa717bf84a018100ff59d51c21'</span>
</code></pre></div></div>

<p>Kita akan menggunakan default rails credensial untuk menyimpannya:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$&gt; EDITOR=vim rails credentials:edit
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lockbox_master_key=103cc6ebf93fd0d146dfdbc8791218bcf07e1dfa717bf84a018100ff59d51c21
</code></pre></div></div>

<p>Dan buat file <code class="language-plaintext highlighter-rouge">config/initializers/lockbox.rb</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Lockbox.master_key = Rails.application.credentials.lockbox_master_key
</code></pre></div></div>

<p>Setelah itu buat file migrasi pada atribute yang ingin kita enkripsi, pada kasus ini adalah salary:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$&gt; rails g migration addSalaryChipertext salary_chipertext:text
</code></pre></div></div>

<p>Lalu jalankan migrationnya:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$&gt; rails db:migrate
</code></pre></div></div>

<p>Dan update model <code class="language-plaintext highlighter-rouge">Employee</code>-nya:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># frozen_string_literal: true</span>

<span class="c1"># Employee</span>
<span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">encrypts</span> <span class="ss">:salary</span><span class="p">,</span> <span class="ss">type: :integer</span><span class="p">,</span> <span class="ss">encode: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Lalu pergi ke halaman web employeesnya dan tambahkan data baru, maka pada db clientnya data akan dibuat begini:</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">id</span><span class="pi">:</span> <span class="m">4</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">something</span>
<span class="na">salary</span><span class="pi">:</span> <span class="m">10000000</span>
<span class="na">salary_ciphertext</span><span class="pi">:</span> <span class="s">3d5Lo+N9DS8Cdbtl4JVSEWCXYjisENn53EqGZ0nRBGc=</span>
</code></pre></div></div>

<p>Artinya enkripsi telah berhasil. Sekarang waktunya untuk migrasi data, karena pada data-data employees sebelumnya tidak memiliki nilai pada field <code class="language-plaintext highlighter-rouge">salary_ciphertext</code>.</p>

<p>Migrasi dapat dilakukan dengan sangat mudah, kita tinggal jalankan kode ini di console:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Lockbox.migrate(Employee)
</code></pre></div></div>

<p>Maka semua field akan memiliki nilai pada field <code class="language-plaintext highlighter-rouge">salary_ciphertext</code>.</p>

<p>Setelah migrasi selesai waktunya untuk menghapus field salary kita, karna percuma saja kita encrypt tapi nilai aslinya masih ada didatabase.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$&gt; rails g migration RemoveSalaryFromEmployees salary:integer
</code></pre></div></div>

<p>Lalu jalankan</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$&gt; rails db:migrate
</code></pre></div></div>

<p>Maka data pada database kita tinggal:</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">id</span><span class="pi">:</span> <span class="m">4</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">something</span>
<span class="na">salary_ciphertext</span><span class="pi">:</span> <span class="s">3d5Lo+N9DS8Cdbtl4JVSEWCXYjisENn53EqGZ0nRBGc=</span>
</code></pre></div></div>

<p>Namun, aplikasi web kita tidak ada yang break. Artinya kita telah berhasil melakukan enkripsi pada database kita.</p>

<p>Namun setelah ini kita ada issue baru, yaitu kita tidak bisa mencari salary yang kita inginkan, karena datanya yang ada di database sudah di enkripsi.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Employee.where(salary: 1_000_000)
#&gt; ActiveRecord::StatementInvalid (Mysql2::Error: Unknown column 'employees.salary' in 'where clause')
</code></pre></div></div>

<p>Issue ini bisa di solve dengan menggunakan blind_index.</p>

<p>Install gem ini dari <code class="language-plaintext highlighter-rouge">Gemfile</code>:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s1">'blind_index'</span>
</code></pre></div></div>

<p>Lalu jalankan <code class="language-plaintext highlighter-rouge">bundle install</code></p>

<p>Lalu update model <code class="language-plaintext highlighter-rouge">Employee</code> kita:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># frozen_string_literal: true</span>

<span class="c1"># Employee</span>
<span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">encrypts</span> <span class="ss">:salary</span><span class="p">,</span> <span class="ss">type: :integer</span><span class="p">,</span> <span class="ss">encode: </span><span class="kp">true</span>
  <span class="n">blind_index</span> <span class="ss">:salary</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Dan buat file migrasi baru:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$&gt; rails g migration addSalaryBidxToEmployees salary_bidx:text
</code></pre></div></div>

<p>Lalu jalankan</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$&gt; rails db:migrate
</code></pre></div></div>

<p>Lalu jalankan kode ini untuk migrasi di level datanya:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BlindIndex.backfill(User)
</code></pre></div></div>

<p>Sekarang di database kita menjadi seperti ini:</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">id</span><span class="pi">:</span> <span class="m">4</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">something</span>
<span class="na">salary_ciphertext</span><span class="pi">:</span> <span class="s">3d5Lo+N9DS8Cdbtl4JVSEWCXYjisENn53EqGZ0nRBGc=</span>
<span class="na">salary_bidx</span><span class="pi">:</span> <span class="s">3d5Lo+N9DS8Cdbtl4JVSEWCXYjisENn53EqGZ0nRBGc=</span>
</code></pre></div></div>

<p>Sekarang sudah solved:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vg">$&gt;</span> <span class="no">Employee</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">salary: </span><span class="mi">1_000_000</span><span class="p">)</span>
<span class="c1">#&lt;ActiveRecord::Relation [#&lt;Employee id: 2, full_name: "Nani what the heels", created_at: "2020-05-22 04:35:17", updated_at: "2020-05-22 05:01:56", salary_bidx: "hjUe8orIAKr6k2XXOCUkVFm9DZ7CYDc2uTc1SdQjrdY="&gt;, #&lt;Employee id: 5, full_name: "This is good employee", created_at: "2020-05-22 04:58:39", updated_at: "2020-05-22 05:01:56", salary_bidx: "hjUe8orIAKr6k2XXOCUkVFm9DZ7CYDc2uTc1SdQjrdY="&gt;]&gt;</span>
</code></pre></div></div>

<p>Jadi ketika database kita dicuri, data salarynya akan aman.</p>

<p>Namun, lain hal jika file log kita juga ikut dicuri.</p>

<p>Jika anda sadar, jika kita lihat file log ketika membuat data employee baru:</p>

<pre><code class="language-log">Started POST "/employees" for ::1 at 2020-05-22 16:09:15 +0700
Processing by EmployeesController#create as HTML
  Parameters: {"authenticity_token"=&gt;"AXc02QtOmL8OzVUght/J89v8WbPwd2yQossbZnepJrCEMPiZRYvoWHepSnpdC4hFFK5qY8xAEJ5dEk6OvkYBNg==", "employee"=&gt;{"full_name"=&gt;"Plain logger", "salary"=&gt;"1000000"}, "commit"=&gt;"Create Employee"}
   (0.3ms)  BEGIN
  ↳ app/controllers/employees_controller.rb:30:in `block in create'
  Employee Create (0.5ms)  INSERT INTO `employees` (`full_name`, `created_at`, `updated_at`, `salary_ciphertext`, `salary_bidx`) VALUES ('Plain logger', '2020-05-22 09:09:15.687197', '2020-05-22 09:09:15.687197', 'rJgUVQwMvqtjTGAy8iHhWC6GhMSXIdMx5UD3p7h6jMAqux4B', 'hjUe8orIAKr6k2XXOCUkVFm9DZ7CYDc2uTc1SdQjrdY=')
  ↳ app/controllers/employees_controller.rb:30:in `block in create'
   (1.7ms)  COMMIT
  ↳ app/controllers/employees_controller.rb:30:in `block in create'
Redirected to http://localhost:3000/employees/8
Completed 302 Found in 29ms (ActiveRecord: 2.5ms | Allocations: 4208)
</code></pre>

<p>Anda akan sadar, salary dan full name dari employee tertulis jelas disana.</p>

<p>Untuk mengatasi masalah ini, kita akan melakukan filter pada field salary secara global dengan fitur bawaan Rails.</p>

<p>Kita bisa update file <code class="language-plaintext highlighter-rouge">config/initializers/filter_parameter_logging.rb</code> menjadi ini:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># frozen_string_literal: true</span>

<span class="c1"># Be sure to restart your server when you modify this file.</span>

<span class="c1"># Configure sensitive parameters which will be filtered from the log file.</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">filter_parameters</span> <span class="o">+=</span> <span class="p">[</span><span class="ss">:password</span><span class="p">]</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">filter_parameters</span> <span class="o">+=</span> <span class="p">[</span><span class="ss">:salary</span><span class="p">]</span>
</code></pre></div></div>

<p>Awalnya rails hanya melakukan filter pada field password saja, sekarang kita tambahkan field baru yaitu <code class="language-plaintext highlighter-rouge">salary</code>.</p>

<p>Maka, anda bisa restart servernya lalu coba tambahkan employee baru, kita akan mendapatkan log seperti ini:</p>

<pre><code class="language-log">Started POST "/employees" for ::1 at 2020-05-22 16:15:36 +0700
Processing by EmployeesController#create as HTML
  Parameters: {"authenticity_token"=&gt;"OmJfyBcAay0myS1nYKyKinCbmiqh0VafUR2c0nJcqvC/JZOIWcUbyl+tMj27eMs8v8mp+p3mKpGuxMk6u7ONdg==", "employee"=&gt;{"full_name"=&gt;"Filtered logs", "salary"=&gt;"[FILTERED]"}, "commit"=&gt;"Create Employee"}
   (0.5ms)  BEGIN
  ↳ app/controllers/employees_controller.rb:30:in `block in create'
  Employee Create (0.7ms)  INSERT INTO `employees` (`full_name`, `created_at`, `updated_at`, `salary_ciphertext`, `salary_bidx`) VALUES ('Filtered logs', '2020-05-22 09:15:36.875876', '2020-05-22 09:15:36.875876', 'bsVU8Vk1iBcacwb2LWMu4okqoVwhtXG4RRYp8h/TJuywQn3B', 'hjUe8orIAKr6k2XXOCUkVFm9DZ7CYDc2uTc1SdQjrdY=')
  ↳ app/controllers/employees_controller.rb:30:in `block in create'
   (1.0ms)  COMMIT
  ↳ app/controllers/employees_controller.rb:30:in `block in create'
Redirected to http://localhost:3000/employees/9
Completed 302 Found in 31ms (ActiveRecord: 2.3ms | Allocations: 4217)
</code></pre>

<p>Oke, sekarang salarynya tidak ditampilkan pada file log kita.</p>

<p>Sekedar saran jika anda mengimplementasi lockbox pada projek anda pastikan file migrasi penambahan field <code class="language-plaintext highlighter-rouge">salary_chipertext</code> dan <code class="language-plaintext highlighter-rouge">salary_bidx</code> dengan penghapusan field <code class="language-plaintext highlighter-rouge">salary</code> (plain) terjadi pada beda deployment. Karna kita terjadi pada satu deployment data salary yang di current production akan menjadi hilang dan anda tidak bisa melakukan migrasi data.</p>

<p>Jadi, pastikan migrasi data terjadi dengan lancar, baru lakukan penghapusan field.</p>

<p>Saya kira cukup sampai disini saja, terima kasih telah membaca tulisan ini :)</p>

:ET